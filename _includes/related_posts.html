{% if page.tags.size > 0 %}
  {% assign related_posts = site.posts | where_exp: "post", "post.url != page.url" %}
  {% assign matching_posts = "" | split: "" %}
  
  {% for post in related_posts %}
    {% assign common_tags = page.tags | where_exp: "tag", "post.tags contains tag" %}
    {% if common_tags.size > 0 %}
      {% assign matching_posts = matching_posts | push: post %}
    {% endif %}
  {% endfor %}
  
  {% if matching_posts.size > 0 %}
    <div class="related-posts">
      <h3>Related Posts</h3>
      <ul class="related-posts-list">
        {% for post in matching_posts limit: 3 %}
          <li class="related-post-item">
            <a href="{{ post.url | relative_url }}" class="related-post-link">
              <span class="related-post-title">{{ post.title }}</span>
              <span class="related-post-date">{{ post.date | date: "%b %-d, %Y" }}</span>
            </a>
            {% assign common_tags = page.tags | where_exp: "tag", "post.tags contains tag" %}
            {% if common_tags.size > 0 %}
              <div class="related-post-tags">
                Common tags: 
                {% for tag in common_tags limit: 2 %}
                  <span class="related-tag">#{{ tag }}</span>{% unless forloop.last %}, {% endunless %}
                {% endfor %}
              </div>
            {% endif %}
          </li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}
{% endif %}

<style>
.related-posts {
  margin: 2rem 0;
  padding: 1.5rem;
  background-color: #f6f8fa;
  border: 1px solid #d1d9e0;
  border-radius: 6px;
}

.related-posts h3 {
  margin-top: 0;
  margin-bottom: 1rem;
  color: #24292e;
  border-bottom: 1px solid #e1e4e8;
  padding-bottom: 0.5rem;
}

.related-posts-list {
  list-style: none;
  padding: 0;
  margin: 0;
}

.related-post-item {
  margin-bottom: 1rem;
  padding: 0.75rem;
  background-color: white;
  border: 1px solid #e1e4e8;
  border-radius: 6px;
  transition: all 0.2s ease;
}

.related-post-item:hover {
  border-color: #0366d6;
  box-shadow: 0 1px 3px rgba(3, 102, 214, 0.1);
}

.related-post-item:last-child {
  margin-bottom: 0;
}

.related-post-link {
  text-decoration: none;
  color: inherit;
  display: block;
}

.related-post-title {
  display: block;
  font-weight: 600;
  color: #24292e;
  margin-bottom: 0.25rem;
}

.related-post-link:hover .related-post-title {
  color: #0366d6;
}

.related-post-date {
  font-size: 0.8rem;
  color: #6a737d;
  display: block;
}

.related-post-tags {
  margin-top: 0.5rem;
  font-size: 0.8rem;
  color: #6a737d;
}

.related-tag {
  color: #0366d6;
  font-weight: 500;
}
</style>
